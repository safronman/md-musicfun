import { Callout } from "nextra/components"

# 16. Streaming update (websokets)

<Callout type={"info"} emoji={"üîó"}>

- [Musicfun WebSocket –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://musicfun.it-incubator.app/async-api)

- [Streaming Updates](https://redux-toolkit.js.org/rtk-query/usage/streaming-updates)

- [onCacheEntryAdded](https://redux-toolkit.js.org/rtk-query/api/createApi#oncacheentryadded)

</Callout>

–ö–æ–≥–¥–∞ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤, —Ç–æ –ª—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç.
–ò —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –æ–± —ç—Ç–æ–º –∑–Ω–∞—Ç—å —Å—Ä–∞–∑—É –∂–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç. –î–ª—è —ç—Ç–æ–≥–æ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É
[socket.io](https://socket.io/)

–£—Å—Ç–∞–Ω–æ–≤–∏–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É [socket.io-client](https://www.npmjs.com/package/socket.io-client)

```bash filename="Terminal"
pnpm add socket.io-client
```

–†–µ–∞–ª–∏–∑—É–µ–º –Ω–∞—à—É –∑–∞–¥–∞—á—É

- [path](https://socket.io/docs/v4/client-options/#path)

```ts filename="playlistsApi.ts" {6-36}
export const playlistsApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    fetchPlaylists: build.query({
      query: (params: FetchPlaylistsArgs) => ({ url: `playlists`, params }),
      ...withZodCatch(playlistsResponseSchema),
      keepUnusedDataFor: 0, // üëà cleanup immediately after unmount
      async onCacheEntryAdded(_arg, { updateCachedData, cacheDataLoaded, cacheEntryRemoved }) {
        // Wait for the initial query to resolve before proceeding
        await cacheDataLoaded

        // Create Socket.IO connection to the server
        const socket: Socket = io("https://musicfun.it-incubator.app", {
          path: "/api/1.0/ws", // custom path for Socket.IO server (default is '/socket.io/')
          transports: ["websocket"],
        })

        socket.on("connect", () => console.log("‚úÖ Connected to server"))

        socket.on("tracks.playlist-created", (msg: PlaylistCreatedEvent) => {
          // 1 variant
          const newPlaylist = msg.payload.data
          updateCachedData((state) => {
            state.data.pop()
            state.data.unshift(newPlaylist)
            state.meta.totalCount = state.meta.totalCount + 1
            state.meta.pagesCount = Math.ceil(state.meta.totalCount / state.meta.pageSize)
          })
          // 2 variant
          // dispatch(playlistsApi.util.invalidateTags(['Playlist']))
        })

        // CacheEntryRemoved will resolve when the cache subscription is no longer active
        await cacheEntryRemoved
        // Perform cleanup steps once the `cacheEntryRemoved` promise resolves
        socket.on("disconnect", () => console.log("‚ùå Connection destroyed"))
      },
      providesTags: ["Playlist"],
    }),
    /*...*/
  }),
})
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ —É –≤–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –Ω–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç üöÄ

## –í—ã–Ω–µ—Å–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏

–ï—Å–ª–∏ –Ω–∞–º –±—É–¥–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–Ω–µ–¥—Ä–∏—Ç—å –≤–µ–±—Å–æ–∫–µ—Ç—ã –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è, —Ç–æ –Ω–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ
—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –ø–æ—ç—Ç–æ–º—É —Å—Ä–∞–∑–∞ –∑–∞—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–º –∏ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º –∫–æ–¥

- `.env`

```env filename=".env" {3}
VITE_BASE_URL=https://musicfun.it-incubator.app/api/1.0
VITE_DOMAIN_ADDRESS=http://localhost:3000
VITE_SOCKET_URL=https://musicfun.it-incubator.app
VITE_API_KEY=
```

- `common/constants.ts`

```ts filename="constants.ts"
/*...*/

export const SOCKET_EVENTS = {
  TRACK_PUBLISHED: "tracks.track-published",
  TRACK_ADDED_TO_PLAYLIST: "tracks.track-added-to-playlist",
  TRACK_LIKED: "tracks.track-liked",
  TRACK_IMAGE_PROCESSED: "tracks.track-image-processed",
  PLAYLIST_IMAGE_PROCESSED: "tracks.playlist-image-processed",
  PLAYLIST_CREATED: "tracks.playlist-created",
  PLAYLIST_UPDATED: "tracks.playlist-updated",
} as const

export type SocketEvents = (typeof SOCKET_EVENTS)[keyof typeof SOCKET_EVENTS]
```

–í—ã–Ω–µ—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–∫–µ—Ç–∞ –≤ –æ–±—â–∏–π –º–æ–¥—É–ª—å

- `common/socket/getSocket.ts`

```ts filename="getSocket.ts"
import { io, Socket } from "socket.io-client"

let socket: Socket | null = null

export const getSocket = (): Socket => {
  if (!socket) {
    socket = io(import.meta.env.VITE_SOCKET_URL, {
      path: "/api/1.0/ws",
      transports: ["websocket"],
    })

    socket.on("connect", () => console.log("‚úÖ Connected to server"))
    socket.on("disconnect", () => console.log("‚ùå Disconnected from server"))
  }
  return socket
}
```

–°–¥–µ–ª–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫ –Ω–∞ —Å–æ–±—ã—Ç–∏—è

- `common/socket/subscribeToEvent.ts`

```ts filename="subscribeToEvent.ts"
import type { SocketEvents } from "@/common/constants"
import { getSocket } from "./getSocket.ts"
import type { Socket } from "socket.io-client"

type Callback<T> = (data: T) => void

export const subscribeToEvent = <T>(event: SocketEvents, callback: Callback<T>) => {
  const socket: Socket = getSocket()
  socket.on(event, callback)

  return () => {
    socket.off(event, callback)
  }
}
```

–í–Ω–µ–¥—Ä–∏–º –∫–æ–¥ –≤ `playlistsApi.ts`

```ts filename="playlistsApi.ts"
export const playlistsApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    fetchPlaylists: build.query({
      query: (params: FetchPlaylistsArgs) => ({ url: `playlists`, params }),
      ...withZodCatch(playlistsResponseSchema),
      keepUnusedDataFor: 0, // üëà cleanup immediately after unmount
      async onCacheEntryAdded(_arg, { updateCachedData, cacheDataLoaded, cacheEntryRemoved }) {
        // Wait for the initial query to resolve before proceeding
        await cacheDataLoaded

        const unsubscribe = subscribeToEvent<PlaylistCreatedEvent>(SOCKET_EVENTS.PLAYLIST_CREATED, (msg) => {
          const newPlaylist = msg.payload.data
          updateCachedData((state) => {
            state.data.pop()
            state.data.unshift(newPlaylist)
            state.meta.totalCount = state.meta.totalCount + 1
            state.meta.pagesCount = Math.ceil(state.meta.totalCount / state.meta.pageSize)
          })
        })

        // CacheEntryRemoved will resolve when the cache subscription is no longer active
        await cacheEntryRemoved
        unsubscribe()
      },
      providesTags: ["Playlist"],
    }),
    /*...*/
  }),
})
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∑–∞—Ä–µ—Ñ–∞–∫–æ—Ç–æ—Ä–∏–ª–∏ –∫–æ–¥ üöÄ

## 3
