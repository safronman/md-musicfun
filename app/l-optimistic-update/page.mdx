# 12. Optimistic update

[`Optimistic Update (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)`](https://redux-toolkit.js.org/rtk-query/usage/manual-cache-updates#optimistic-updates) - –ø–æ–¥—Ö–æ–¥ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`UI`) –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏.
–î—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
–∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –∏ —Å—Ä–∞–∑—É –≤–Ω–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `UI`. –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
–Ω–µ—É–¥–∞—á–Ω–æ, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `UI` –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Optimistic Update:**

- **—É–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –Ω–∞ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ–ª–µ–µ –æ—Ç–∑—ã–≤—á–∏–≤—ã–º;
- **—Å–Ω–∏–∂–µ–Ω–∏–µ –æ—â—É—â–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏**: –¥–∞–∂–µ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `UI`;

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ Optimistic Update:**

- **—Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π;
- **–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É, –∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, `UI` –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏;

## –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞

–ü–µ—Ä–µ–ø–∏—à–µ–º –Ω–∞ `optimistic update` —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.

[updateQueryData](https://redux-toolkit.js.org/rtk-query/api/created-api/api-slice-utils#updatequerydata) –ª–æ–∫–∞–ª—å–Ω–æ
–æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–µ—Ç –æ–±—ä–µ–∫—Ç –¥–µ–π—Å—Ç–≤–∏—è. –ü—Ä–∏ `dispatch` —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è,
–≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç `dispatch` - –æ–±—ä–µ–∫—Ç `patchResult`. –ï—Å–ª–∏ –≤—ã–∑–≤–∞—Ç—å `patchResult.undo()`,
–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –æ—Ç–º–µ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- `playlistsApi.ts`

```ts filename="playlistsApi.ts"
export const playlistsApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    /*...*/
    updatePlaylist: build.mutation<void, { playlistId: string; body: UpdatePlaylistArgs }>({
      query: ({ playlistId, body }) => ({ url: `playlists/${playlistId}`, method: "put", body }),
      async onQueryStarted({ playlistId, body }, { dispatch, queryFulfilled }) {
        const patchResult = dispatch(
          playlistsApi.util.updateQueryData(
            // –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
            "fetchPlaylists",
            // –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
            { pageNumber: 1, pageSize: 2, search: "" },
            // `updateRecipe` - –∫–æ–ª–ª–±—ç–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞ –º—É—Ç–∞–±–µ–ª—å–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
            (state) => {
              const index = state.data.findIndex((playlist) => playlist.id === playlistId)
              if (index !== -1) {
                state.data[index].attributes = { ...state.data[index].attributes, ...body }
              }
            },
          ),
        )
        try {
          await queryFulfilled
        } catch {
          patchResult.undo()
        }
      },
      invalidatesTags: ["Playlist"],
    }),
  }),
})
```

- `EditPlaylistForm.tsx`

```ts filename="EditPlaylistForm.ts" {7}
export const EditPlaylistForm = ({ playlistId, handleSubmit, register, editPlaylist, setPlaylistId }: Props) => {
  const [updatePlaylist] = useUpdatePlaylistMutation()

  const onSubmit: SubmitHandler<UpdatePlaylistArgs> = (data) => {
    if (!playlistId) return
    updatePlaylist({ playlistId, body: data })
    setPlaylistId(null)
  }

  /*...*/
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –æ–Ω —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `UI` üöÄ
- –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, —Ç–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ `UI` –æ—Ç–∫–∞—Ç—è—Ç—Å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ üöÄ

### selectCachedArgsForQuery

–ï—Å–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤, —Ç–æ `optimistic update` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç üò¢

[selectCachedArgsForQuery](https://redux-toolkit.js.org/rtk-query/api/created-api/api-slice-utils#selectcachedargsforquery) –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ `Redux Store`.
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –∏–º–µ—é—â–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã–µ –∫—ç—à–∏. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–æ–≥–æ,
–∫–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã –∏ —Å –∫–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:

```ts filename="playlistsApi.ts" {14-38}
export const playlistsApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    /*...*/
    updatePlaylist: build.mutation<void, { playlistId: string; body: UpdatePlaylistArgs }>({
      query: ({ playlistId, body }) => ({ url: `playlists/${playlistId}`, method: "put", body }),
      async onQueryStarted({ playlistId, body }, { dispatch, queryFulfilled, getState }) {
        const args = playlistsApi.util.selectCachedArgsForQuery(getState(), "fetchPlaylists")

        const patchResults: any[] = []

        args.forEach((arg) => {
          patchResults.push(
            dispatch(
              playlistsApi.util.updateQueryData(
                "fetchPlaylists",
                {
                  pageNumber: arg.pageNumber,
                  pageSize: arg.pageSize,
                  search: arg.search,
                },
                (state) => {
                  const index = state.data.findIndex((playlist) => playlist.id === playlistId)
                  if (index !== -1) {
                    state.data[index].attributes = { ...state.data[index].attributes, ...body }
                  }
                },
              ),
            ),
          )
        })

        try {
          await queryFulfilled
        } catch {
          patchResults.forEach((patchResult) => {
            patchResult.undo()
          })
        }
      },
      invalidatesTags: ["Playlist"],
    }),
  }),
})
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `optimistic update` –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å `query`-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ üöÄ
