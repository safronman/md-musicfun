import { Callout } from "nextra/components"

# Zod. RTK query

üîó [–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ–¥](https://github.com/safronman/zod-redux-toolkit-rtk-query/tree/6623221fb6d3ce4e52e5bda40b825381a98b3e7c)

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ `RTK query` –º—ã —É–±—Ä–∞–ª–∏ `thunk` –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ `ZOD` –≤–∞–ª–∏–¥–∞—Ü–∏—é.

–ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –∫–∞–∫ –ø–æ–¥—Ä—É–∂–∏—Ç—å `ZOD` –∏ `RTK query`

<Callout type={"info"} emoji={"üîó"}>
  [Use zod with query and mutation](https://github.com/reduxjs/redux-toolkit/discussions/3404)
</Callout>

## –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ transformResponse

–ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∞–¥–∞–ª–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–µ—Ä–Ω—ã, —Ç–æ –º–æ–∂–Ω–æ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ `transformResponse`

```tsx filename="tasksApi.ts" {8}
export const tasksApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    getTasks: build.query<GetTasksResponse, { todolistId: string; params: { page: number } }>({
      query: ({ todolistId, params }) => ({
        url: `todo-lists/${todolistId}/tasks`,
        params: { ...params, count: PAGE_SIZE },
      }),
      transformResponse: (res: GetTasksResponse) => getTasksSchema.parse(res),
      providesTags: (_res, _err, { todolistId }) => [{ type: "Task", id: todolistId }],
    }),
  }),
})
```

–ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è –≤—ã–≤–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª—å, —Ç–æ –ø—Ä–∏–¥–µ—Ç—Å—è –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–æ–¥ –≤ `try...catch`.
–í –∫–æ–Ω—Å–æ–ª—å –≤—ã–≤–µ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—Å—è, –Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –Ω–∞ UI –ø—Ä–∏ —Ç–∞–∫–æ–º –ø–æ–¥—Ö–æ–¥–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ü§î

<Callout>
  –í `transformResponse` —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `dispatch`, –ø–æ—Ç–æ–º—É —á—Ç–æ

- –≠—Ç–æ —á–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ —Å—Ç–æ—Ä.

- –û–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `middleware RTK Query`, –≥–¥–µ `dispatch` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

</Callout>

```tsx filename="tasksApi.ts" {8-19}
export const tasksApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    getTasks: build.query<GetTasksResponse, { todolistId: string; params: { page: number } }>({
      query: ({ todolistId, params }) => ({
        url: `todo-lists/${todolistId}/tasks`,
        params: { ...params, count: PAGE_SIZE },
      }),
      transformResponse: (res: GetTasksResponse) => {
        try {
          getTasksSchema.parse(res) // üíé ZOD
        } catch (error) {
          if (error instanceof z.ZodError) {
            console.table(error.issues)
            // ‚ùå
            // dispatch(setAppErrorAC({ error: "Zod error. –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å" }))
          }
        }
        return res
      },
      providesTags: (_res, _err, { todolistId }) => [{ type: "Task", id: todolistId }],
    }),
  }),
})
```

‚ùó –¢–∞–∫–∂–µ –∫ –º–∏–Ω—É—Å—É —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ —Ç–æ, —á—Ç–æ –º—ã –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å —Ç–∞–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–∞–∂–¥–æ–º `endpoints`,
—á—Ç–æ –ø—Ä–∏–ª–∏—á–Ω–æ –∑–∞—Å–æ—Ä–∏—Ç –∫–æ–¥.

## –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —É—Ç–∏–ª–∏—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ extraOptions

–°–∫–æ–ø–∏—Ä—É–µ–º –∏–∑ [github discussions](https://github.com/reduxjs/redux-toolkit/discussions/3404#discussioncomment-6182956) —É—Ç–∏–ª–∏—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `baseQueryWithZodValidation`.

<Callout type={"error"} emoji={"‚ùó"}>
  –í–Ω–µ—Å–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ. –í –±–ª–æ–∫–µ `catch` –±—É–¥–µ–º –≤—ã–≤–æ–¥–∏—Ç—å –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ `UI`
</Callout>

```ts filename="common/utils/baseQueryWithZodValidation.ts"  {34-37}
import { ZodSchema } from "zod"
import type { BaseQueryFn, FetchArgs, FetchBaseQueryError, FetchBaseQueryMeta } from "@reduxjs/toolkit/query/react"

type TBaseQuery = BaseQueryFn<
  string | FetchArgs,
  unknown,
  FetchBaseQueryError,
  { dataSchema?: ZodSchema },
  FetchBaseQueryMeta
>

/**
 * HOF that wraps a base query function with additional functionality for data validation using zod
 *
 * @param baseQuery The base query function to be wrapped.
 * @returns A modified version of the baseQuery with added data validation.
 */
const baseQueryWithZodValidation: (baseQuery: TBaseQuery) => TBaseQuery =
  (baseQuery: TBaseQuery) => async (args, api, extraOptions) => {
    // Call the original baseQuery function with the provided arguments
    const returnValue = await baseQuery(args, api, extraOptions)

    // Retrieve the data schema from the extraOptions object
    const zodSchema = extraOptions?.dataSchema

    const { data } = returnValue

    // Check if both 'data' and 'zodSchema' are defined
    if (data && zodSchema) {
      // throws Validation error if the 'data' fails validation.
      try {
        zodSchema.parse(data)
      } catch (error) {
        if (error instanceof z.ZodError) {
          console.table(error.issues)
          api.dispatch(setAppErrorAC({ error: "Zod error. –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å" }))
        }
        throw error
      }
    }

    // Return the original returnValue object
    return returnValue
  }
```

–¢–µ–ø–µ—Ä—å –æ–±–µ—Ä–Ω–µ–º `baseQuery` –≤ `baseQueryWithZodValidation`

```ts filename="baseApi.ts" /baseQueryWithZodValidation/
export const baseApi = createApi({
  reducerPath: "todolistsApi",
  tagTypes: ["Todolist", "Task"],
  baseQuery: baseQueryWithZodValidation(async (args, api, extraOptions) => {
    const result = await fetchBaseQuery({
      baseUrl: import.meta.env.VITE_BASE_URL,
      prepareHeaders: (headers) => {
        headers.set("API-KEY", import.meta.env.VITE_API_KEY)
        headers.set("Authorization", `Bearer ${import.meta.env.VITE_AUTH_TOKEN}`)
      },
    })(args, api, extraOptions)

    handleError(api, result)

    return result
  }),
  endpoints: () => ({}),
})
```

–ò –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ç–µ–ø–µ—Ä—å –≤ –∫–∞–∂–¥—ã–π endpoint –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ö–µ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—É–¥–µ—Ç –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
—Å–≤–æ–π—Å—Ç–≤–æ–º [extraOptions](https://redux-toolkit.js.org/rtk-query/api/createApi#extraoptions) –≤ –∫–æ—Ç–æ—Ä—ã–π –∏ –±—É–¥–µ–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```ts filename="tasksApi.ts" {8}
export const tasksApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    getTasks: build.query<GetTasksResponse, { todolistId: string; params: { page: number } }>({
      query: ({ todolistId, params }) => ({
        url: `todo-lists/${todolistId}/tasks`,
        params: { ...params, count: PAGE_SIZE },
      }),
      extraOptions: { dataSchema: getTasksSchema },
      providesTags: (_res, _err, { todolistId }) => [{ type: "Task", id: todolistId }],
    }),
    /*...*/
  }),
})
```

–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–∑–º–µ–Ω–∏—Ç—å –≤ `domainTaskSchema` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –±—É–¥–µ—Ç –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å üöÄ

#### –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è endpoints

–ò —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º `ZOD` –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ –≤—Å–µ—Ö `endpoints` –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å

```ts filename="tasksApi.ts"  {5, 9, 13, 20}
export const tasksApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    getTasks: build.query<GetTasksResponse, { todolistId: string; params: { page: number } }>({
      /*...*/
      extraOptions: { dataSchema: getTasksSchema },
    }),
    addTask: build.mutation<TaskOperationResponse, { todolistId: string; title: string }>({
      /*...*/
      extraOptions: { dataSchema: taskOperationResponseSchema },
    }),
    removeTask: build.mutation<DefaultResponse, { todolistId: string; taskId: string }>({
      /*...*/
      extraOptions: { dataSchema: defaultResponseSchema },
    }),
    updateTask: build.mutation<TaskOperationResponse, { todolistId: string; taskId: string; model: UpdateTaskModel }>({
      /*...*/
      extraOptions: { dataSchema: taskOperationResponseSchema },
    }),
  }),
})
```

```ts filename="todolistsApi.ts"  {5, 9, 13, 17}
export const todolistsApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    getTodolists: build.query<DomainTodolist[], void>({
      /*...*/
      extraOptions: { dataSchema: todolistSchema.array() },
    }),
    addTodolist: build.mutation<CreateTodolistResponse, string>({
      /*...*/
      extraOptions: { dataSchema: createTodolistResponseSchema },
    }),
    removeTodolist: build.mutation<DefaultResponse, string>({
      /*...*/
      extraOptions: { dataSchema: defaultResponseSchema },
    }),
    updateTodolistTitle: build.mutation<DefaultResponse, { id: string; title: string }>({
      /*...*/
      extraOptions: { dataSchema: defaultResponseSchema },
    }),
  }),
})
```

–ü–æ–∑–¥—Ä–∞–≤–ª—è—é. –¢–µ–ø–µ—Ä—å –≤—ã –∑–Ω–∞–µ—Ç–µ –∫–∞–∫ –¥—Ä—É–∂–∏—Ç—å `ZOD` —Å `RTK query` üéâ

üîó [–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç](https://github.com/safronman/zod-redux-toolkit-rtk-query/tree/0802be1ad0acb6cb1bdda52f63fdb479124fb724)
