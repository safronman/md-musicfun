import { Callout } from "nextra/components"

# 13. Auth

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª–∏—Å—å, –Ω–æ –º–æ–∂–µ–º –¥–µ–ª–∞—Ç—å `CRUD` –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –º—ã –ø—Ä–æ–ø–∏—Å–∞–ª–∏
`VITE_ACCESS_TOKEN` –≤ `.local.env` –∏ –ø—Ä–∏–∫—Ä–µ–ø–∏–ª–∏ –≤ `prepareHeaders`

```ts filename="baseApi" {10}
export const baseApi = createApi({
  /*...*/
  baseQuery: async (args, api, extraOptions) => {
    const result = await fetchBaseQuery({
      baseUrl: import.meta.env.VITE_BASE_URL,
      headers: {
        "API-KEY": import.meta.env.VITE_API_KEY,
      },
      prepareHeaders: (headers) => {
        headers.set("Authorization", `Bearer ${import.meta.env.VITE_ACCESS_TOKEN}`)
        return headers
      },
    })(args, api, extraOptions)
    /*...*/
  },
})
```

<Callout type={"error"} emoji={'‚ùó'}>

–£–¥–∞–ª–∏—Ç–µ `VITE_ACCESS_TOKEN` –∏–∑ `.env.local`

</Callout>

–¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –∫–∞–∫ –¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ `RTK query`

## Login

### OAuth login

–°–æ–≥–ª–∞—Å–Ω–æ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](https://musicfun.it-incubator.app/api#/Authentication) —Ä–µ–∞–ª–∏–∑—É–µ–º `api` —Å–ª–æ–π –¥–ª—è `login`.

- `authApi.ts`

```ts filename="authApi.ts"
export const authApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    /*...*/
    login: build.mutation<AuthTokensResponse, LoginArgs>({
      query: (payload) => ({
        url: `auth/login`,
        method: "post",
        body: { ...payload, accessTokenTTL: "3m" },
      }),
    }),
  }),
})
```

- `authApi.types.ts`

```ts filename="authApi.types.ts"
/*...*/

export type AuthTokensResponse = {
  refreshToken: string
  accessToken: string
}

// Arguments
export type LoginArgs = {
  code: string
  redirectUri: string
  rememberMe: boolean
  accessTokenTTL?: string // e.g. "3m"
}
```

–°–æ–∑–¥–∞–¥–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `Login.tsx` –∏ —Ä–∞–∑–º–µ—Å—Ç–∏–º –¥–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ `Header.tsx`

- `Login.tsx`

```tsx filename="Login.tsx"
export const Login = () => {
  const [login] = useLoginMutation()

  const loginHandler = () => {
    login({ code: "", redirectUri: "", rememberMe: false })
  }

  return (
    <button type={"button"} onClick={loginHandler}>
      login
    </button>
  )
}
```

- `Header.tsx`

```tsx filename="Header.tsx" {2, 7-8}
export const Header = () => {
  const { data } = useGetMeQuery()

  return (
    <header className={s.container}>
      {/*...*/}
      {data && data.login}
      {!data && <Login />}
    </header>
  )
}
```

- `Header.module.css`

```css filename="Header.module.css" {3-6}
.container {
  border-bottom: 1px solid black;
  padding: 0 100px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
```

### OAuth redirect

–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å –æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç—å `code` –∏ `redirectUri`.

**–ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω, —á—Ç–æ –º—ã –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å:**

- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É `"login"`, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è popup-–æ–∫–Ω–æ –¥–ª—è `OAuth-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏` –≤ –∫–æ—Ç–æ—Ä–æ–µ –ø–µ—Ä–µ–¥–∞–µ–º
  [url](https://musicfun.it-incubator.app/api#/Authentication/AuthController_OauthRedirect)

- –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä `OAuth` —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ /oauth/callback?code=....

- –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `OAuthCallback` –¥–æ—Å—Ç–∞—ë—Ç code –∏ —Å –ø–æ–º–æ—â—å—é `postMessage` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ
  –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∞ –∑–∞—Ç–µ–º –∑–∞–∫—Ä—ã–≤–∞–µ—Ç popup.

<Callout type={"info"} emoji={"üîó"}>
  [window.postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) ‚Äî —ç—Ç–æ
  —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –≤ –±—Ä–∞—É–∑–µ—Ä–∞—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏, –≤–∫–ª–∞–¥–∫–∞–º–∏
  –∏–ª–∏ —Ñ—Ä–µ–π–º–∞–º–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —Å —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ (`cross-origin`). –≠—Ç–æ –æ–¥–∏–Ω –∏–∑ –Ω–µ–º–Ω–æ–≥–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤
  –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É, –Ω–∞–ø—Ä–∏–º–µ—Ä, popup-–æ–∫–Ω–æ–º –∏ –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.

</Callout>

- –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≤–∏—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –≤—ã–∑—ã–≤–∞–µ—Ç `login mutation` (–æ–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥, –≥–¥–µ –ø–æ code –≤—ã–¥–∞—é—Ç —Ç–æ–∫–µ–Ω).

- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º.

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

- `.env`

```env filename=".env" {2}
VITE_BASE_URL=https://musicfun.it-incubator.app/api/1.0
VITE_DOMAIN_ADDRESS=http://localhost:3000
VITE_API_KEY=
```

- `features/auth/ui/OAuthCallback/OAuthCallback.tsx`

```tsx filename="OAuthCallback.tsx"
// Component triggered after successful OAuth authorization,
// its purpose is to send the code back to the main app window and close the popup
export const OAuthCallback = () => {
  useEffect(() => {
    // Get the current URL
    const url = new URL(window.location.href)

    // Extract code from query parameters
    const code = url.searchParams.get("code")

    if (code && window.opener) {
      window.opener.postMessage({ code }, "*")
    }

    window.close()
  }, [])

  return <p>Logging you in...</p>
}
```

- `Routing.tsx`

```tsx filename="Routing.tsx" {3, 10}
export const Path = {
  /*...*/
  OAuthRedirect: "/oauth/callback",
  NotFound: "*",
} as const

export const Routing = () => (
  <Routes>
    {/*...*/}
    <Route path={Path.OAuthRedirect} element={<OAuthCallback />} />
    <Route path={Path.NotFound} element={<PageNotFound />} />
  </Routes>
)
```

- `Login.tsx`

```tsx filename="Login.tsx"
export const Login = () => {
  const [login] = useLoginMutation()

  const loginHandler = () => {
    // Build the redirect URI after authorization
    const redirectUri = import.meta.env.VITE_DOMAIN_ADDRESS + Path.OAuthRedirect

    // Build the OAuth authorization endpoint URL, adding callbackUrl as a query parameter
    const url = `${import.meta.env.VITE_BASE_URL}/auth/oauth-redirect?callbackUrl=${redirectUri}`

    // Open a popup window for OAuth authorization
    window.open(url, "oauthPopup", "width=500, height=600")

    // Handler function to receive messages from the popup window
    const receiveMessage = async (event: MessageEvent) => {
      if (event.origin !== import.meta.env.VITE_DOMAIN_ADDRESS) return

      const { code } = event.data
      if (!code) return

      // Unsubscribe from the event to avoid handling duplicate messages
      window.removeEventListener("message", receiveMessage)
      login({ code, redirectUri, rememberMe: false })
    }

    // Subscribe to messages from the popup window
    window.addEventListener("message", receiveMessage)
  }

  return (
    <button type={"button"} onClick={loginHandler}>
      login
    </button>
  )
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** login –∑–∞–ø—Ä–æ—Å —É—Ö–æ–¥–∏—Ç –∏ –≤ –æ—Ç–≤–µ—Ç–µ –º—ã –ø–æ–ª—É—á–∞–µ–º 2 jwt —Ç–æ–∫–µ–Ω–∞: (`refreshToken` –∏ `accessToken`) üöÄ

## AccessToken –∏ refreshToken

### –¢–µ–æ—Ä–∏—è

**–ó–∞—á–µ–º backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `accessToken` –∏ `refreshToken`?**

1. **`accessToken` (—Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞)**

- –û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–∫–µ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª, ¬´—Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑¬ª –∏ —Ç.–¥.).
- **–ö–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π** (–æ–±—ã—á–Ω–æ 5‚Äì30 –º–∏–Ω—É—Ç): –µ—Å–ª–∏ –µ–≥–æ —É–∫—Ä–∞–¥—É—Ç, –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–µ —Å–º–æ–∂–µ—Ç –¥–æ–ª–≥–æ –∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

2. **`refreshToken` (—Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)**

- –•—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (—á–∞—â–µ –≤—Å–µ–≥–æ ‚Äî –≤ httpOnly cookie).
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API!
- –ï–≥–æ –∑–∞–¥–∞—á–∞ ‚Äî **–æ–±–Ω–æ–≤–ª—è—Ç—å accessToken**, –∫–æ–≥–¥–∞ —Ç–æ—Ç –∏—Å—Ç—ë–∫.
- **–î–æ–ª–≥–æ –∂–∏–≤—ë—Ç** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π, –Ω–µ–¥–µ–ª—å –∏–ª–∏ –¥–∞–∂–µ –º–µ—Å—è—Ü–µ–≤).

**–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ–±–∞ —Ç–æ–∫–µ–Ω–∞**.
2. –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `accessToken` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤.
3. –ö–æ–≥–¥–∞ `accessToken` –∏—Å—Ç–µ–∫–∞–µ—Ç:

- 3.1. –ö–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (refresh) —Å –ø–æ–º–æ—â—å—é `refreshToken`.
- 3.2. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `refreshToken`, –∏ –µ—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –≤—ã–¥–∞—ë—Ç –Ω–æ–≤—ã–π `accessToken` (–∏ –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å `refreshToken`).
- 3.3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —Ä–∞–∑–ª–æ–≥–∏–Ω–∞.

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ? (–æ—Å–Ω–æ–≤–Ω—ã–µ –ø–ª—é—Å—ã)**

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.**
  –ï—Å–ª–∏ `accessToken` —É–∫—Ä–∞–¥—É—Ç ‚Äî –µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–µ –±—ã—Å—Ç—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è, –∞ `refreshToken` —Ö—Ä–∞–Ω–∏—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ
  (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ JS).
- **–£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.**
  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç, —á—Ç–æ `accessToken` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Äî —Å–µ—Å—Å–∏—è ¬´–≤–µ—á–Ω–∞—è¬ª, –ø–æ–∫–∞ –∂–∏–≤ `refreshToken`
  (–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã—à–µ–ª –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞).
- **–ö–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Å—Å–∏–π.**
  –ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å `refreshToken` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

### –ü—Ä–∞–∫—Ç–∏–∫–∞

- `common/constants/constants.ts`

```tsx filename="constants.tsx"
export const AUTH_KEYS = {
  accessToken: "musicfun-access-token",
  refreshToken: "musicfun-refresh-token",
} as const
```

- `baseApi.ts`

```tsx filename="baseApi.ts" /"Auth"/1 {11-14}
export const baseApi = createApi({
  reducerPath: "baseApi",
  tagTypes: ["Playlist", "Auth"],
  baseQuery: async (args, api, extraOptions) => {
    const result = await fetchBaseQuery({
      baseUrl: import.meta.env.VITE_BASE_URL,
      headers: {
        "API-KEY": import.meta.env.VITE_API_KEY,
      },
      prepareHeaders: (headers) => {
        const accessToken = localStorage.getItem(AUTH_KEYS.accessToken)
        if (accessToken) {
          headers.set("Authorization", `Bearer ${accessToken}`)
        }
        return headers
      },
    })(args, api, extraOptions)

    if (result.error) {
      handleErrors(result.error)
    }

    return result
  },
  endpoints: () => ({}),
})
```

- `authApi.ts`

```ts filename="authApi.ts" {10-16}
export const authApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    /*...*/
    login: build.mutation<AuthTokensResponse, LoginArgs>({
      query: (payload) => ({
        url: `auth/login`,
        method: "post",
        body: { ...payload, accessTokenTTL: "3m" },
      }),
      async onQueryStarted(_arg, { dispatch, queryFulfilled }) {
        const { data } = await queryFulfilled
        localStorage.setItem(AUTH_KEYS.accessToken, data.accessToken)
        localStorage.setItem(AUTH_KEYS.refreshToken, data.refreshToken)
        // Invalidate after saving tokens
        dispatch(authApi.util.invalidateTags(["Auth"]))
      },
    }),
  }),
})
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- —Å–æ—Ö—Ä–∞–Ω—è–µ–º `refreshToken` –∏ `accessToken` –≤ localstorage üöÄ
- –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º `accessToken` –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É üöÄ
- –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å me –∑–∞–ø—Ä–æ—Å üöÄ

## Logout

–†–µ–∞–ª–∏–∑—É–µ–º [logout](https://musicfun.it-incubator.app/api#/Authentication/AuthController_logout)

<Callout type={'info'} emoji={'üîó'}>
  - [resetApiState](https://redux-toolkit.js.org/rtk-query/api/created-api/api-slice-utils#resetapistate)
  —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–æ `API slice`, –≤–∫–ª—é—á–∞—è –∫—ç—à –∑–∞–ø—Ä–æ—Å–æ–≤

</Callout>

- `baseApi.ts`

```ts filename="baseApi.ts"
export const authApi = baseApi.injectEndpoints({
  endpoints: (build) => ({
    /*...*/

    logout: build.mutation<void, void>({
      query: () => {
        const refreshToken = localStorage.getItem(AUTH_KEYS.refreshToken)
        return { url: "auth/logout", method: "post", body: { refreshToken } }
      },
      async onQueryStarted(_args, { queryFulfilled, dispatch }) {
        await queryFulfilled
        localStorage.removeItem(AUTH_KEYS.accessToken)
        localStorage.removeItem(AUTH_KEYS.refreshToken)
        dispatch(baseApi.util.resetApiState())
      },
    }),
  }),
})
```

- `Header.tsx`

```tsx filename="Header.tsx" {3, 5, 10-15}
export const Header = () => {
  const { data } = useGetMeQuery()
  const [logout] = useLogoutMutation()

  const logoutHandler = () => logout()

  return (
    <header className={s.container}>
      {/*...*/}
      {data && (
        <div className={s.loginContainer}>
          <p>{data.login}</p>
          <button onClick={logoutHandler}>logout</button>
        </div>
      )}
      {!data && <Login />}
    </header>
  )
}
```

- `Header.module.css`

```css filename="Header.module.css"
/*...*/
.loginContainer {
  display: flex;
  gap: 10px;
  align-items: center;
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤—ã–ª–æ–≥–∏–Ω–∏–≤–∞—Ç—å—Å—è üöÄ

## Re-authorization

–¢–µ–ø–µ—Ä—å —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –∑–∞—á–µ–º –Ω–∞–º –Ω—É–∂–µ–Ω `refreshToken` –∏ –∫–∞–∫ —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å

–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –ø—Ä–∏ –ª–æ–≥–∏–Ω–∏–∑–∞—Ü–∏–∏ —É–∫–∞–∂–∏—Ç–µ `accessTokenTTL` —Ä–∞–≤–Ω—ã–π –Ω–∞–ø—Ä–∏–º–µ—Ä `10s`. –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ
–æ–±–Ω–æ–≤–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç, —É –≤–∞—Å –≤—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å. –ü–æ—Ç–æ–º –ø–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫—É–Ω–¥ –∏ –æ–ø—è—Ç—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å, –¥–æ–ª–∂–Ω–∞ —É–ø–∞—Å—Ç—å
–æ—à–∏–±–∫–∞, —Ç.–∫. –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ `accessToken` –∏—Å—Ç–µ–∫–ª–æ –∏ –æ–Ω —Å—Ç–∞–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º.

–ß—Ç–æ–±—ã —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É —Ä–µ–∞–ª–∏–∑—É–µ–º [/auth/refresh](https://musicfun.it-incubator.app/api#/Authentication/AuthController_refresh)

<Callout type={"info"} emoji={'üîó'}>

- [Automatic re-authorization by extending
  fetchBaseQuery](https://redux-toolkit.js.org/rtk-query/usage/customizing-queries#automatic-re-authorization-by-extending-fetchbasequery)

</Callout>

–ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç —Å [async-mutex](https://safronman.gitbook.io/jwt-formdata-optimistic-update) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `'/refreshToken'`

–£—Å—Ç–∞–Ω–æ–≤–∏–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É [async-mutex](https://www.npmjs.com/package/async-mutex)

```bash filename="Terminal"
pnpm add async-mutex
```

<Callout type={'info'}>
  –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `async-mutex` –Ω—É–∂–Ω–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç—É–ø–æ–º –∫ –æ–±—â–∏–º –¥–∞–Ω–Ω—ã–º –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ. –û–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç
  –∏–∑–±–µ–∂–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏–π, –∫–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—ã—Ç–∞—é—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ
  (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –æ–±—ä–µ–∫—Ç –∏–ª–∏ –º–∞—Å—Å–∏–≤), —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**
`async-mutex` –ø–æ–∑–≤–æ–ª—è–µ—Ç ¬´–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å¬ª —Ä–µ—Å—É—Ä—Å –¥–ª—è –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∂–¥–∞–ª–∏ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏. –≠—Ç–æ –∫–∞–∫ –æ—á–µ—Ä–µ–¥—å
–≤ –º–∞–≥–∞–∑–∏–Ω ‚Äî –ø–æ–∫–∞ –æ–¥–∏–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –Ω–∞ –∫–∞—Å—Å–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—ã.

</Callout>

- `baseQuery.ts`

```ts filename="baseQuery.ts"
import { AUTH_KEYS } from "@/common/constants"
import { fetchBaseQuery } from "@reduxjs/toolkit/query/react"

export const baseQuery = fetchBaseQuery({
  baseUrl: import.meta.env.VITE_BASE_URL,
  headers: {
    "API-KEY": import.meta.env.VITE_API_KEY,
  },
  prepareHeaders: (headers) => {
    const accessToken = localStorage.getItem(AUTH_KEYS.accessToken)
    if (accessToken) {
      headers.set("Authorization", `Bearer ${accessToken}`)
    }
    return headers
  },
})
```

- `baseApi.ts`

```ts filename="baseApi.ts" {8}
import { baseQueryWithReauth } from "@/app/api/baseQueryWithReauth.ts"
import { createApi } from "@reduxjs/toolkit/query/react"

export const baseApi = createApi({
  reducerPath: "baseApi",
  tagTypes: ["Playlist", "Auth"],
  endpoints: () => ({}),
  baseQuery: baseQueryWithReauth,
})
```

- `baseQueryWithReauth.ts`

```ts filename="baseQueryWithReauth.ts"
import { baseApi } from "@/app/api/baseApi.ts"
import { baseQuery } from "@/app/api/baseQuery.ts"
import { AUTH_KEYS } from "@/common/constants"
import { handleErrors, isTokens } from "@/common/utils"
import type { BaseQueryFn, FetchArgs, FetchBaseQueryError } from "@reduxjs/toolkit/query/react"
import { Mutex } from "async-mutex"

// Create a new mutex to manage concurrent refresh token requests
const mutex = new Mutex()

export const baseQueryWithReauth: BaseQueryFn<string | FetchArgs, unknown, FetchBaseQueryError> = async (
  args,
  api,
  extraOptions,
) => {
  // Wait for any ongoing refresh token operation to finish (if mutex is locked)
  await mutex.waitForUnlock()

  // Perform the original API request
  let result = await baseQuery(args, api, extraOptions)

  // If the request failed with a 401 Unauthorized error
  if (result.error && result.error.status === 401) {
    // Check if mutex is not already locked (i.e., no other refresh in progress)
    if (!mutex.isLocked()) {
      // Lock the mutex so only one refresh request is processed at a time
      const release = await mutex.acquire()
      try {
        const refreshToken = localStorage.getItem(AUTH_KEYS.refreshToken)

        const refreshResult = await baseQuery(
          { url: "/auth/refresh", method: "post", body: { refreshToken } },
          api,
          extraOptions,
        )

        if (refreshResult.data && isTokens(refreshResult.data)) {
          localStorage.setItem(AUTH_KEYS.accessToken, refreshResult.data.accessToken)
          localStorage.setItem(AUTH_KEYS.refreshToken, refreshResult.data.refreshToken)
          // Retry the original request with the new access token
          result = await baseQuery(args, api, extraOptions)
        } else {
          // If refresh failed, trigger logout
          // @ts-expect-error
          api.dispatch(baseApi.endpoints.logout.initiate())
        }
      } finally {
        // Always release the mutex after refreshing is done
        release()
      }
    } else {
      // If a refresh is already in progress, wait for it to fini
      await mutex.waitForUnlock()
      // Retry the original request after tokens have been refreshed
      result = await baseQuery(args, api, extraOptions)
    }
  }

  // Handle all errors except 401 Unauthorized (which are handled above)
  if (result.error && result.error.status !== 401) {
    handleErrors(result.error)
  }

  return result
}
```

<Callout type={"warning"}>
  –ò–∑ `handleErrors.ts` —É–¥–∞–ª–∏—Ç–µ case `401`, —Ç.–∫. –æ—à–∏–±–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ –¥—Ä—É–≥–æ–º—É
</Callout>

- `commin/utils/isTokens.ts`

```ts filename="isTokens.ts"
export const isTokens = (data: unknown): data is { accessToken: string; refreshToken: string } => {
  return typeof data === "object" && data !== null && "accessToken" in data && "refreshToken" in data
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ üöÄ

### Refresh errors

–ï—Å–ª–∏ –º—ã –≤—ã–ª–æ–≥–∏–Ω–∏–º—Å—è –º—ã —É–≤–∏–¥–∏–º –æ—à–∏–±–∫—É, —Ç.–∫. –∏–¥–µ—Ç `refresh` –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–∏–º `refresh` —Ç–æ–∫–µ–Ω–æ–º.

```bash filename="console"
{
  status: "400",
  code: 5,
  title: "Validation failed",
  detail: "refreshToken must be a string; Received value: null",
  source: {
    pointer: "/data/attributes/refreshToken",
  },
  meta: {
    timestamp: "2025-07-22T13:12:47.617Z",
    path: "/api/1.0/auth/refresh",
  },
}
```

–ù–æ –º—ã –Ω–µ –º–æ–∂–µ–º –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 400. –ù–∞–º –Ω–µ –Ω—É–∂–Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å —Ç–æ–∫–µ–Ω–æ–º. –ü–æ—ç—Ç–æ–º—É
–Ω–µ–º–Ω–æ–≥–æ –¥–æ—Ä–∞–±–æ—Ç–∞–µ–º `400 case`

```ts filename="handleErrors"
case 400:
  if (isErrorWithDetailArray(error.data)) {
    const errorMessage = error.data.errors[0].detail
    if (errorMessage.includes("refreshToken")) return
    errorToast(trimToMaxLength(errorMessage))
  } else {
    errorToast(JSON.stringify(error.data))
  }
break
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Refresh errors –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ UI üöÄ
